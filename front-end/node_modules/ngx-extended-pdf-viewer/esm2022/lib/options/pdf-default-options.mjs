import { AnnotationMode } from './editor-annotations';
const _isIE11 = typeof window === 'undefined' ? false : !!globalThis.MSInputMethodContext && !!document.documentMode;
const isEdge = typeof navigator === 'undefined' || /Edge\/\d./i.test(navigator.userAgent);
const needsES5 = typeof ReadableStream === 'undefined' || typeof Promise['allSettled'] === 'undefined';
export const pdfjsVersion = '4.10.718';
export const pdfjsBleedingEdgeVersion = '4.10.718';
export function getVersionSuffix(folder) {
    if (folder?.includes('bleeding-edge')) {
        return pdfjsBleedingEdgeVersion;
    }
    return pdfjsVersion;
}
export function assetsUrl(url, postfixIfPathIsRelativ = '') {
    if (url.includes('://')) {
        // the assets folder is on an absolute path (like https://example.com/assets)
        return url;
    }
    return `./${url + postfixIfPathIsRelativ}`;
}
function isTestEnvironment() {
    return (typeof process !== 'undefined' &&
        typeof process.env !== 'undefined' &&
        (process.env.NODE_ENV === 'test' || process.env.JEST_WORKER_ID !== undefined || process.env.VITEST !== undefined));
}
export function getSafeCanvasSize() {
    if (typeof window === 'undefined' || typeof document === 'undefined' || isTestEnvironment()) {
        return 4096;
    }
    // Create a temporary WebGL context
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    let maxTextureSize;
    if (gl instanceof WebGLRenderingContext) {
        maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
    }
    else {
        maxTextureSize = 4096;
    }
    // Get available device RAM (in MB)
    function getAvailableMemoryMB() {
        if ('deviceMemory' in navigator) {
            return navigator.deviceMemory * 1024; // Convert GB to MB
        }
        if (window.performance && 'memory' in window.performance) {
            return window.performance.memory.jsHeapSizeLimit / 1024 / 1024; // Only works on Chrome, Firefox, and Edgewindow.performance.memory.jsHeapSizeLimit / 1024 / 1024; // Only works on Chrome
        }
        return 4096; // Default to 4GB if unknown
    }
    const availableMemoryMB = getAvailableMemoryMB();
    // Conservative formula: Scale by square root of available memory
    let estimatedSafeSize = Math.floor(Math.sqrt((availableMemoryMB * 1024 * 1024) / 6));
    // Apply platform-specific limits
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !('MSStream' in window);
    const isMobile = /Android|iPhone|iPad|iPod/.test(navigator.userAgent);
    const isHighEndDesktop = availableMemoryMB > 12000; // Assume high-end desktops have >12GB RAM
    if (isIOS) {
        estimatedSafeSize = Math.min(estimatedSafeSize, 4096); // iOS Safari memory limits
    }
    else if (isMobile) {
        estimatedSafeSize = Math.min(estimatedSafeSize, 4096); // Most mobile devices
    }
    else if (isHighEndDesktop) {
        estimatedSafeSize = Math.min(estimatedSafeSize, 8192); // Allow larger sizes for desktops
    }
    else {
        estimatedSafeSize = Math.min(estimatedSafeSize, 6000); // Mid-range desktops
    }
    // Final limit based on GPU and estimated memory safety
    const maxWidth = Math.min(maxTextureSize, estimatedSafeSize);
    return maxWidth * maxWidth;
}
// sonar ignore next line
export const pdfDefaultOptions = {
    needsES5: _isIE11 || isEdge || needsES5,
    annotationEditorMode: 0,
    annotationMode: AnnotationMode.ENABLE_FORMS,
    defaultZoomDelay: 400,
    cursorToolOnLoad: 0,
    defaultUrl: '',
    defaultZoomValue: '',
    disableHistory: false,
    disablePageLabels: false,
    enablePermissions: false,
    docBaseUrl: '',
    enablePrintAutoRotate: true,
    externalLinkRel: 'noopener noreferrer nofollow',
    externalLinkTarget: 0,
    findController: undefined,
    historyUpdateUrl: false,
    ignoreDestinationZoom: false,
    imageResourcesPath: './images/',
    maxCanvasPixels: getSafeCanvasSize(),
    forcePageColors: false,
    pageColorsBackground: 'Canvas',
    pageColorsForeground: 'CanvasText',
    pdfBugEnabled: false,
    printResolution: 150,
    rangeChunkSize: 65536,
    removePageBorders: false,
    enableXfa: true,
    fontExtraProperties: false,
    sidebarViewOnLoad: -1,
    scrollModeOnLoad: -1,
    spreadModeOnLoad: -1,
    textLayerMode: 1,
    // viewerCssTheme: 0, // not supported by ngx-extended-pdf-viewer, use [theme] instead
    viewOnLoad: 0,
    cMapPacked: true,
    cMapUrl: function () {
        return `${assetsUrl(pdfDefaultOptions.assetsFolder, '/..')}/cmaps/`;
    },
    disableAutoFetch: false,
    disableFontFace: false,
    disableRange: false,
    disableStream: true,
    isEvalSupported: true,
    isOffscreenCanvasSupported: true,
    maxImageSize: -1,
    pdfBug: false,
    verbosity: 1,
    workerPort: null,
    assetsFolder: 'assets',
    _internalFilenameSuffix: '.min',
    sandboxBundleSrc: function () {
        return pdfDefaultOptions.needsES5
            ? `./pdf.sandbox-${getVersionSuffix(assetsUrl(pdfDefaultOptions.assetsFolder))}-es5.mjs`
            : `./pdf.sandbox-${getVersionSuffix(assetsUrl(pdfDefaultOptions.assetsFolder))}${pdfDefaultOptions._internalFilenameSuffix}.mjs`;
    },
    workerSrc: function () {
        return pdfDefaultOptions.needsES5
            ? `${assetsUrl(pdfDefaultOptions.assetsFolder)}/pdf.worker-${getVersionSuffix(assetsUrl(pdfDefaultOptions.assetsFolder))}-es5.mjs`
            : `${assetsUrl(pdfDefaultOptions.assetsFolder)}/pdf.worker-${getVersionSuffix(assetsUrl(pdfDefaultOptions.assetsFolder))}${pdfDefaultOptions._internalFilenameSuffix}.mjs`;
    },
    standardFontDataUrl: () => `${assetsUrl(pdfDefaultOptions.assetsFolder, '/..')}/standard_fonts/`,
    // options specific to ngx-extended-pdf-viewer (as opposed to being used by pdf.js)
    doubleTapZoomFactor: 'page-width',
    doubleTapZoomsInHandMode: true,
    doubleTapZoomsInTextSelectionMode: false,
    doubleTapResetsZoomOnSecondDoubleTap: false,
    enableScripting: true,
    defaultCacheSize: 50,
    passwordPrompt: undefined,
    enableHWA: true,
    positionPopupDialogsWithJavaScript: true,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRmLWRlZmF1bHQtb3B0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1leHRlbmRlZC1wZGYtdmlld2VyL3NyYy9saWIvb3B0aW9ucy9wZGYtZGVmYXVsdC1vcHRpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV0RCxNQUFNLE9BQU8sR0FBRyxPQUFPLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFPLFVBQVcsQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLENBQU8sUUFBUyxDQUFDLFlBQVksQ0FBQztBQUNuSSxNQUFNLE1BQU0sR0FBRyxPQUFPLFNBQVMsS0FBSyxXQUFXLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDMUYsTUFBTSxRQUFRLEdBQUcsT0FBTyxjQUFjLEtBQUssV0FBVyxJQUFJLE9BQU8sT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLFdBQVcsQ0FBQztBQUV2RyxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDO0FBQ3ZDLE1BQU0sQ0FBQyxNQUFNLHdCQUF3QixHQUFHLFVBQVUsQ0FBQztBQUNuRCxNQUFNLFVBQVUsZ0JBQWdCLENBQUMsTUFBYztJQUM3QyxJQUFJLE1BQU0sRUFBRSxRQUFRLENBQUMsZUFBZSxDQUFDLEVBQUU7UUFDckMsT0FBTyx3QkFBd0IsQ0FBQztLQUNqQztJQUNELE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxNQUFNLFVBQVUsU0FBUyxDQUFDLEdBQVcsRUFBRSxzQkFBc0IsR0FBRyxFQUFFO0lBQ2hFLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN2Qiw2RUFBNkU7UUFDN0UsT0FBTyxHQUFHLENBQUM7S0FD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QUNsSSxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLGVBQWUsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQ3BILGlCQUFpQixDQUFDLHVCQUNwQixNQUFNLENBQUM7SUFDYixDQUFDO0lBQ0QsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxrQkFBa0I7SUFFaEcsbUZBQW1GO0lBQ25GLG1CQUFtQixFQUFFLFlBQVk7SUFDakMsd0JBQXdCLEVBQUUsSUFBSTtJQUM5QixpQ0FBaUMsRUFBRSxLQUFLO0lBQ3hDLG9DQUFvQyxFQUFFLEtBQUs7SUFDM0MsZUFBZSxFQUFFLElBQUk7SUFDckIsZ0JBQWdCLEVBQUUsRUFBRTtJQUNwQixjQUFjLEVBQUUsU0FBUztJQUN6QixTQUFTLEVBQUUsSUFBSTtJQUNmLGtDQUFrQyxFQUFFLElBQUk7Q0FDekMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFubm90YXRpb25Nb2RlIH0gZnJvbSAnLi9lZGl0b3ItYW5ub3RhdGlvbnMnO1xuXG5jb25zdCBfaXNJRTExID0gdHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgPyBmYWxzZSA6ICEhKDxhbnk+Z2xvYmFsVGhpcykuTVNJbnB1dE1ldGhvZENvbnRleHQgJiYgISEoPGFueT5kb2N1bWVudCkuZG9jdW1lbnRNb2RlO1xuY29uc3QgaXNFZGdlID0gdHlwZW9mIG5hdmlnYXRvciA9PT0gJ3VuZGVmaW5lZCcgfHwgL0VkZ2VcXC9cXGQuL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTtcbmNvbnN0IG5lZWRzRVM1ID0gdHlwZW9mIFJlYWRhYmxlU3RyZWFtID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgUHJvbWlzZVsnYWxsU2V0dGxlZCddID09PSAndW5kZWZpbmVkJztcblxuZXhwb3J0IGNvbnN0IHBkZmpzVmVyc2lvbiA9ICc0LjEwLjcxOCc7XG5leHBvcnQgY29uc3QgcGRmanNCbGVlZGluZ0VkZ2VWZXJzaW9uID0gJzQuMTAuNzE4JztcbmV4cG9ydCBmdW5jdGlvbiBnZXRWZXJzaW9uU3VmZml4KGZvbGRlcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgaWYgKGZvbGRlcj8uaW5jbHVkZXMoJ2JsZWVkaW5nLWVkZ2UnKSkge1xuICAgIHJldHVybiBwZGZqc0JsZWVkaW5nRWRnZVZlcnNpb247XG4gIH1cbiAgcmV0dXJuIHBkZmpzVmVyc2lvbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc2V0c1VybCh1cmw6IHN0cmluZywgcG9zdGZpeElmUGF0aElzUmVsYXRpdiA9ICcnKTogc3RyaW5nIHtcbiAgaWYgKHVybC5pbmNsdWRlcygnOi8vJykpIHtcbiAgICAvLyB0aGUgYXNzZXRzIGZvbGRlciBpcyBvbiBhbiBhYnNvbHV0ZSBwYXRoIChsaWtlIGh0dHBzOi8vZXhhbXBsZS5jb20vYXNzZXRzKVxuICAgIHJldHVybiB1cmw7XG4gIH1cbiAgcmV0dXJuIGAuLyR7dXJsICsgcG9zdGZpeElmUGF0aElzUmVsYXRpdn1gO1xufVxuXG5kZWNsYXJlIGNvbnN0IHByb2Nlc3M6IGFueTtcblxuZnVuY3Rpb24gaXNUZXN0RW52aXJvbm1lbnQoKTogYm9vbGVhbiB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIChwcm9jZXNzIGFzIGFueSkuZW52ICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICgocHJvY2VzcyBhcyBhbnkpLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnIHx8IChwcm9jZXNzIGFzIGFueSkuZW52LkpFU1RfV09SS0VSX0lEICE9PSB1bmRlZmluZWQgfHwgKHByb2Nlc3MgYXMgYW55KS5lbnYuVklURVNUICE9PSB1bmRlZmluZWQpXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTYWZlQ2FudmFzU2l6ZSgpOiBudW1iZXIge1xuICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGRvY3VtZW50ID09PSAndW5kZWZpbmVkJyB8fCBpc1Rlc3RFbnZpcm9ubWVudCgpKSB7XG4gICAgcmV0dXJuIDQwOTY7XG4gIH1cbiAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IFdlYkdMIGNvbnRleHRcbiAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gIGNvbnN0IGdsID0gY2FudmFzLmdldENvbnRleHQoJ3dlYmdsJykgfHwgY2FudmFzLmdldENvbnRleHQoJ2V4cGVyaW1lbnRhbC13ZWJnbCcpO1xuICBsZXQgbWF4VGV4dHVyZVNpemU7XG4gIGlmIChnbCBpbnN0YW5jZW9mIFdlYkdMUmVuZGVyaW5nQ29udGV4dCkge1xuICAgIG1heFRleHR1cmVTaXplID0gZ2wuZ2V0UGFyYW1ldGVyKGdsLk1BWF9URVhUVVJFX1NJWkUpO1xuICB9IGVsc2Uge1xuICAgIG1heFRleHR1cmVTaXplID0gNDA5NjtcbiAgfVxuICAvLyBHZXQgYXZhaWxhYmxlIGRldmljZSBSQU0gKGluIE1CKVxuICBmdW5jdGlvbiBnZXRBdmFpbGFibGVNZW1vcnlNQigpOiBudW1iZXIge1xuICAgIGlmICgnZGV2aWNlTWVtb3J5JyBpbiBuYXZpZ2F0b3IpIHtcbiAgICAgIHJldHVybiAobmF2aWdhdG9yLmRldmljZU1lbW9yeSBhcyBudW1iZXIpICogMTAyNDsgLy8gQ29udmVydCBHQiB0byBNQlxuICAgIH1cbiAgICBpZiAod2luZG93LnBlcmZvcm1hbmNlICYmICdtZW1vcnknIGluIHdpbmRvdy5wZXJmb3JtYW5jZSkge1xuICAgICAgcmV0dXJuICh3aW5kb3cucGVyZm9ybWFuY2UubWVtb3J5IGFzIGFueSkuanNIZWFwU2l6ZUxpbWl0IC8gMTAyNCAvIDEwMjQ7IC8vIE9ubHkgd29ya3Mgb24gQ2hyb21lLCBGaXJlZm94LCBhbmQgRWRnZXdpbmRvdy5wZXJmb3JtYW5jZS5tZW1vcnkuanNIZWFwU2l6ZUxpbWl0IC8gMTAyNCAvIDEwMjQ7IC8vIE9ubHkgd29ya3Mgb24gQ2hyb21lXG4gICAgfVxuICAgIHJldHVybiA0MDk2OyAvLyBEZWZhdWx0IHRvIDRHQiBpZiB1bmtub3duXG4gIH1cblxuICBjb25zdCBhdmFpbGFibGVNZW1vcnlNQiA9IGdldEF2YWlsYWJsZU1lbW9yeU1CKCk7XG5cbiAgLy8gQ29uc2VydmF0aXZlIGZvcm11bGE6IFNjYWxlIGJ5IHNxdWFyZSByb290IG9mIGF2YWlsYWJsZSBtZW1vcnlcbiAgbGV0IGVzdGltYXRlZFNhZmVTaXplID0gTWF0aC5mbG9vcihNYXRoLnNxcnQoKGF2YWlsYWJsZU1lbW9yeU1CICogMTAyNCAqIDEwMjQpIC8gNikpO1xuXG4gIC8vIEFwcGx5IHBsYXRmb3JtLXNwZWNpZmljIGxpbWl0c1xuICBjb25zdCBpc0lPUyA9IC9pUGFkfGlQaG9uZXxpUG9kLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmICEoJ01TU3RyZWFtJyBpbiB3aW5kb3cpO1xuICBjb25zdCBpc01vYmlsZSA9IC9BbmRyb2lkfGlQaG9uZXxpUGFkfGlQb2QvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7XG4gIGNvbnN0IGlzSGlnaEVuZERlc2t0b3AgPSBhdmFpbGFibGVNZW1vcnlNQiA+IDEyMDAwOyAvLyBBc3N1bWUgaGlnaC1lbmQgZGVza3RvcHMgaGF2ZSA+MTJHQiBSQU1cblxuICBpZiAoaXNJT1MpIHtcbiAgICBlc3RpbWF0ZWRTYWZlU2l6ZSA9IE1hdGgubWluKGVzdGltYXRlZFNhZmVTaXplLCA0MDk2KTsgLy8gaU9TIFNhZmFyaSBtZW1vcnkgbGltaXRzXG4gIH0gZWxzZSBpZiAoaXNNb2JpbGUpIHtcbiAgICBlc3RpbWF0ZWRTYWZlU2l6ZSA9IE1hdGgubWluKGVzdGltYXRlZFNhZmVTaXplLCA0MDk2KTsgLy8gTW9zdCBtb2JpbGUgZGV2aWNlc1xuICB9IGVsc2UgaWYgKGlzSGlnaEVuZERlc2t0b3ApIHtcbiAgICBlc3RpbWF0ZWRTYWZlU2l6ZSA9IE1hdGgubWluKGVzdGltYXRlZFNhZmVTaXplLCA4MTkyKTsgLy8gQWxsb3cgbGFyZ2VyIHNpemVzIGZvciBkZXNrdG9wc1xuICB9IGVsc2Uge1xuICAgIGVzdGltYXRlZFNhZmVTaXplID0gTWF0aC5taW4oZXN0aW1hdGVkU2FmZVNpemUsIDYwMDApOyAvLyBNaWQtcmFuZ2UgZGVza3RvcHNcbiAgfVxuXG4gIC8vIEZpbmFsIGxpbWl0IGJhc2VkIG9uIEdQVSBhbmQgZXN0aW1hdGVkIG1lbW9yeSBzYWZldHlcbiAgY29uc3QgbWF4V2lkdGggPSBNYXRoLm1pbihtYXhUZXh0dXJlU2l6ZSwgZXN0aW1hdGVkU2FmZVNpemUpO1xuICByZXR1cm4gbWF4V2lkdGggKiBtYXhXaWR0aDtcbn1cblxuLy8gc29uYXIgaWdub3JlIG5leHQgbGluZVxuZXhwb3J0IGNvbnN0IHBkZkRlZmF1bHRPcHRpb25zID0ge1xuICBuZWVkc0VTNTogX2lzSUUxMSB8fCBpc0VkZ2UgfHwgbmVlZHNFUzUsXG4gIGFubm90YXRpb25FZGl0b3JNb2RlOiAwLFxuICBhbm5vdGF0aW9uTW9kZTogQW5ub3RhdGlvbk1vZGUuRU5BQkxFX0ZPUk1TLFxuICBkZWZhdWx0Wm9vbURlbGF5OiA0MDAsIC8vIG1pbGxpc2Vjb25kc1xuICBjdXJzb3JUb29sT25Mb2FkOiAwLFxuICBkZWZhdWx0VXJsOiAnJyxcbiAgZGVmYXVsdFpvb21WYWx1ZTogJycsXG4gIGRpc2FibGVIaXN0b3J5OiBmYWxzZSxcbiAgZGlzYWJsZVBhZ2VMYWJlbHM6IGZhbHNlLFxuICBlbmFibGVQZXJtaXNzaW9uczogZmFsc2UsXG4gIGRvY0Jhc2VVcmw6ICcnLFxuICBlbmFibGVQcmludEF1dG9Sb3RhdGU6IHRydWUsXG4gIGV4dGVybmFsTGlua1JlbDogJ25vb3BlbmVyIG5vcmVmZXJyZXIgbm9mb2xsb3cnLFxuICBleHRlcm5hbExpbmtUYXJnZXQ6IDAsXG4gIGZpbmRDb250cm9sbGVyOiB1bmRlZmluZWQsIC8vIG11c3QgZXh0ZW5kIFBERkZpbmRDb250cm9sbGVyXG4gIGhpc3RvcnlVcGRhdGVVcmw6IGZhbHNlLFxuICBpZ25vcmVEZXN0aW5hdGlvblpvb206IGZhbHNlLFxuICBpbWFnZVJlc291cmNlc1BhdGg6ICcuL2ltYWdlcy8nLFxuICBtYXhDYW52YXNQaXhlbHM6IGdldFNhZmVDYW52YXNTaXplKCksXG4gIGZvcmNlUGFnZUNvbG9yczogZmFsc2UsXG4gIHBhZ2VDb2xvcnNCYWNrZ3JvdW5kOiAnQ2FudmFzJyxcbiAgcGFnZUNvbG9yc0ZvcmVncm91bmQ6ICdDYW52YXNUZXh0JyxcbiAgcGRmQnVnRW5hYmxlZDogZmFsc2UsXG4gIHByaW50UmVzb2x1dGlvbjogMTUwLFxuICByYW5nZUNodW5rU2l6ZTogNjU1MzYsXG4gIHJlbW92ZVBhZ2VCb3JkZXJzOiBmYWxzZSxcbiAgZW5hYmxlWGZhOiB0cnVlLFxuICBmb250RXh0cmFQcm9wZXJ0aWVzOiBmYWxzZSxcbiAgc2lkZWJhclZpZXdPbkxvYWQ6IC0xLFxuICBzY3JvbGxNb2RlT25Mb2FkOiAtMSxcbiAgc3ByZWFkTW9kZU9uTG9hZDogLTEsXG4gIHRleHRMYXllck1vZGU6IDEsXG4gIC8vIHZpZXdlckNzc1RoZW1lOiAwLCAvLyBub3Qgc3VwcG9ydGVkIGJ5IG5neC1leHRlbmRlZC1wZGYtdmlld2VyLCB1c2UgW3RoZW1lXSBpbnN0ZWFkXG4gIHZpZXdPbkxvYWQ6IDAsXG4gIGNNYXBQYWNrZWQ6IHRydWUsXG4gIGNNYXBVcmw6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gYCR7YXNzZXRzVXJsKHBkZkRlZmF1bHRPcHRpb25zLmFzc2V0c0ZvbGRlciwgJy8uLicpfS9jbWFwcy9gO1xuICB9LFxuICBkaXNhYmxlQXV0b0ZldGNoOiBmYWxzZSxcbiAgZGlzYWJsZUZvbnRGYWNlOiBmYWxzZSxcbiAgZGlzYWJsZVJhbmdlOiBmYWxzZSxcbiAgZGlzYWJsZVN0cmVhbTogdHJ1ZSxcbiAgaXNFdmFsU3VwcG9ydGVkOiB0cnVlLFxuICBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZDogdHJ1ZSxcbiAgbWF4SW1hZ2VTaXplOiAtMSxcbiAgcGRmQnVnOiBmYWxzZSxcbiAgdmVyYm9zaXR5OiAxLFxuICB3b3JrZXJQb3J0OiBudWxsLFxuICBhc3NldHNGb2xkZXI6ICdhc3NldHMnLFxuICBfaW50ZXJuYWxGaWxlbmFtZVN1ZmZpeDogJy5taW4nLCAvLyBkb24ndCBtb2RpZnkgdGhpcyAtIGl0J3MgYW4gaW50ZXJuYWwgZmllbGRcbiAgc2FuZGJveEJ1bmRsZVNyYzogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBwZGZEZWZhdWx0T3B0aW9ucy5uZWVkc0VTNVxuICAgICAgPyBgLi9wZGYuc2FuZGJveC0ke2dldFZlcnNpb25TdWZmaXgoYXNzZXRzVXJsKHBkZkRlZmF1bHRPcHRpb25zLmFzc2V0c0ZvbGRlcikpfS1lczUubWpzYFxuICAgICAgOiBgLi9wZGYuc2FuZGJveC0ke2dldFZlcnNpb25TdWZmaXgoYXNzZXRzVXJsKHBkZkRlZmF1bHRPcHRpb25zLmFzc2V0c0ZvbGRlcikpfSR7cGRmRGVmYXVsdE9wdGlvbnMuX2ludGVybmFsRmlsZW5hbWVTdWZmaXh9Lm1qc2A7XG4gIH0sXG4gIHdvcmtlclNyYzogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBwZGZEZWZhdWx0T3B0aW9ucy5uZWVkc0VTNVxuICAgICAgPyBgJHthc3NldHNVcmwocGRmRGVmYXVsdE9wdGlvbnMuYXNzZXRzRm9sZGVyKX0vcGRmLndvcmtlci0ke2dldFZlcnNpb25TdWZmaXgoYXNzZXRzVXJsKHBkZkRlZmF1bHRPcHRpb25zLmFzc2V0c0ZvbGRlcikpfS1lczUubWpzYFxuICAgICAgOiBgJHthc3NldHNVcmwocGRmRGVmYXVsdE9wdGlvbnMuYXNzZXRzRm9sZGVyKX0vcGRmLndvcmtlci0ke2dldFZlcnNpb25TdWZmaXgoYXNzZXRzVXJsKHBkZkRlZmF1bHRPcHRpb25zLmFzc2V0c0ZvbGRlcikpfSR7XG4gICAgICAgICAgcGRmRGVmYXVsdE9wdGlvbnMuX2ludGVybmFsRmlsZW5hbWVTdWZmaXhcbiAgICAgICAgfS5tanNgO1xuICB9LFxuICBzdGFuZGFyZEZvbnREYXRhVXJsOiAoKSA9PiBgJHthc3NldHNVcmwocGRmRGVmYXVsdE9wdGlvbnMuYXNzZXRzRm9sZGVyLCAnLy4uJyl9L3N0YW5kYXJkX2ZvbnRzL2AsXG5cbiAgLy8gb3B0aW9ucyBzcGVjaWZpYyB0byBuZ3gtZXh0ZW5kZWQtcGRmLXZpZXdlciAoYXMgb3Bwb3NlZCB0byBiZWluZyB1c2VkIGJ5IHBkZi5qcylcbiAgZG91YmxlVGFwWm9vbUZhY3RvcjogJ3BhZ2Utd2lkdGgnLFxuICBkb3VibGVUYXBab29tc0luSGFuZE1vZGU6IHRydWUsXG4gIGRvdWJsZVRhcFpvb21zSW5UZXh0U2VsZWN0aW9uTW9kZTogZmFsc2UsXG4gIGRvdWJsZVRhcFJlc2V0c1pvb21PblNlY29uZERvdWJsZVRhcDogZmFsc2UsXG4gIGVuYWJsZVNjcmlwdGluZzogdHJ1ZSxcbiAgZGVmYXVsdENhY2hlU2l6ZTogNTAsXG4gIHBhc3N3b3JkUHJvbXB0OiB1bmRlZmluZWQsXG4gIGVuYWJsZUhXQTogdHJ1ZSwgLy8gZW5hYmxlIGhhcmR3YXJlIGFjY2VsZXJhdGlvbi4gQWN0aXZlIHNpbmNlIHBkZi5qcyA0LjQuXG4gIHBvc2l0aW9uUG9wdXBEaWFsb2dzV2l0aEphdmFTY3JpcHQ6IHRydWUsXG59O1xuIl19