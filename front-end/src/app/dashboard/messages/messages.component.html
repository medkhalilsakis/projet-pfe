<div class="messagerie-container" fxLayout="row" fxLayout.xs="column" fxLayoutFill>
  <!-- Sidebar utilisateurs (30%) -->
  <aside class="sidebar"
         fxFlex="30%"
         fxFlex.xs="100%"
         fxLayout="column">

    <div class="logo-bar" fxFlex="none">
      <h1>Mon Chat</h1>
    </div>

    <mat-form-field appearance="outline"
                    class="search-bar"
                    fxFlex="none">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput
             [(ngModel)]="searchQuery"
             placeholder="Rechercher un contact">
    </mat-form-field>

    <mat-nav-list class="user-list" fxFlex>
      <mat-list-item *ngFor="let u of sortedUsers"
                     (click)="selectUser(u)"
                     [class.selected]="u.id === selectedUser?.id"
                     fxLayout="row"
                     fxLayoutAlign="start center">
        <img matListAvatar
             [src]="u.avatarUrl"
             alt="{{u.prenom}}"
             class="avatar-sm">
        <div class="user-details" fxFlex>
          <div class="user-name" *ngIf="u.unread > 9">{{ u.prenom }} {{ u.nom }} +9</div>
          <div class="user-name" *ngIf="u.unread > 0 && u.unread <= 9">{{ u.prenom }} {{ u.nom }} {{u.unread}}</div>
          <div class="user-name" *ngIf="u.unread === 0">{{ u.prenom }} {{ u.nom }}</div>

          <div class="user-status">
            <span [class.online]="u.online" [class.offline]="!u.online"></span>
            {{ getStatus(u) }}
          </div>                    
        </div>
      </mat-list-item>
    </mat-nav-list>
    

  </aside>

  <!-- Zone de chat (70%) -->
  <section class="chat-area"
           *ngIf="selectedUser"
           fxFlex="70%"
           fxFlex.xs="100%"
           fxLayout="column">

    <!-- En-tête conversation -->
    <header class="chat-header" fxFlex="none">
      <button mat-icon-button *ngIf="isMobile" (click)="deselectUser()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="chat-recipient" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="12px">
        <img class="avatar-sm" [src]="selectedUser.avatarUrl" alt="{{selectedUser.nom}}">
        <div>
          <h2>{{ selectedUser.prenom }} {{ selectedUser.nom }}  </h2>
        </div>
      </div>
      <div class="header-actions" fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="8px">
        <button mat-icon-button (click)="openContactDetails()">
          <mat-icon>info</mat-icon>
        </button>
      </div>
    </header>

    <!-- Messages -->
    <!-- Messages -->
<div class="messages" #scrollContainer fxFlex>
  <ng-container *ngFor="let m of messages">
    <div class="msg-row" [ngClass]="{ 'sent': m.sentBy === 'me', 'received': m.sentBy !== 'me' }" fxLayout="row" fxLayoutAlign="{{ m.sentBy === 'me' ? 'end center' : 'start center' }}">
      <ng-container *ngIf="m.sentBy === 'me'">
        <div class="bubble">
          <p>{{ m.text }}</p>
          <ng-container *ngIf="m.attachments?.length">
            <ng-container *ngFor="let att of m.attachments">
          <div class="attachment-row">
            <!-- icône selon le type -->
            <ng-container [ngSwitch]="att.mimeType.split('/')[0]">
              <img *ngSwitchCase="'image'" class="att-img" [src]="att.filePath" (click)="openMediaViewer(att.filePath, att.mimeType)">
              <video *ngSwitchCase="'video'" class="att-video" controls [src]="att.filePath" (click)="openMediaViewer(att.filePath, att.mimeType)"></video>
              <mat-icon *ngSwitchDefault>insert_drive_file</mat-icon>
            </ng-container>
            <!-- nom du fichier et bouton téléchargement -->
            <span class="att-name">{{ att.fileName }}</span>
            <a class="att-download"
     [href]="att.filePath"              
     [attr.download]="att.fileName"
     title="Télécharger {{ att.fileName }}">
    <mat-icon>cloud_download</mat-icon>
  </a>
          </div>
</ng-container>

          </ng-container>
        </div>
      </ng-container>
      <ng-container *ngIf="m.sentBy === 'other'">
        <div class="bubble">
          <button mat-icon-button
          class="msg-delete"
          (click)="deleteMessage(m)"
          title="Supprimer le message">
            <mat-icon>delete</mat-icon>
          </button>
          <p>{{ m.text }}</p>
          <ng-container *ngIf="m.attachments?.length">
            <ng-container *ngFor="let att of m.attachments">
              <ng-container [ngSwitch]="att.mimeType.split('/')[0]">
                <!-- Afficher l'image -->
                <img *ngSwitchCase="'image'" class="att-img" [src]="att.filePath" (click)="openMediaViewer(att.filePath, att.mimeType)">
                <!-- Afficher la vidéo -->
                <video *ngSwitchCase="'video'" class="att-video" controls [src]="att.filePath" (click)="openMediaViewer(att.filePath, att.mimeType)">
                </video>
                <a *ngSwitchDefault class="att-file" [href]="att.filePath" download>
                  <mat-icon>insert_drive_file</mat-icon>{{ att.fileName }}
                </a>
              </ng-container>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </ng-container>
</div>

    

    <div *ngIf="selectedFiles.length > 0" class="attachment-preview">
      <div *ngFor="let file of selectedFiles" class="attachment-item">
        <span>{{ file.name }}</span>
        <button mat-icon-button (click)="removeAttachment(file)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
    <!-- Saisie de nouveau message -->
    <footer class="chat-input" fxFlex="none" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
      
      <button mat-icon-button (click)="fileInput.click()">
        <mat-icon>attach_file</mat-icon>
      </button>
      <input #fileInput type="file" multiple hidden (change)="onAttachmentChange($event)">
      <mat-form-field appearance="outline" class="input-box" fxFlex>
        <input matInput [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" placeholder="Écrire un message…">
      </mat-form-field>
      <button mat-fab color="primary" (click)="sendMessage()">
        <mat-icon>send</mat-icon>
      </button>
    </footer>
    

  </section>

</div>
