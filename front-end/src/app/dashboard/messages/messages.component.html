<div class="messagerie-container">

  <!-- SIDEBAR UTILISATEURS -->
  <aside class="sidebar" *ngIf="!isMobile || !selectedUser">
    <mat-form-field appearance="outline" class="search-bar">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput [(ngModel)]="searchQuery" placeholder="Rechercher">
    </mat-form-field>

    <div class="user-list">
      <mat-card *ngFor="let user of filteredUsers()"
                class="user-card"
                [class.selected]="user.id===selectedUser?.id"
                (click)="selectUser(user)">
        <div class="user-card-content">

          <!-- si l'utilisateur a un avatar en base, on l'affiche, sinon avatar par défaut -->
          <ng-container *ngIf="user.hasImage; else defaultAvatarTpl">
            <img
              [src]="user.avatarUrl"
              class="avatar"
              alt="avatar"
              (error)="user.avatarUrl = 'https://i.imgur.com/vtrfxgY.png'">
          </ng-container>
          <ng-template #defaultAvatarTpl>
            <img
              src="https://i.imgur.com/vtrfxgY.png"
              class="avatar"
              alt="avatar">
          </ng-template>

          <div class="user-info">
            <h3>{{ user.prenom }} {{ user.nom }}</h3>
            <p class="status">{{ user.status }}</p>
          </div>
        </div>
      </mat-card>
    </div>
  </aside>

  <!-- CHAT AREA -->
  <section class="chat-area" *ngIf="selectedUser">
    <header class="chat-header">
      <button mat-icon-button *ngIf="isMobile" (click)="deselectUser()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="chat-user-info">

        <!-- avatar de l'utilisateur sélectionné ou avatar par défaut en cas d'erreur/404 -->
        <ng-container *ngIf="selectedUser.hasImage; else defaultSelAvatarTpl">
          <img
            [src]="selectedUser.avatarUrl"
            class="avatar-sm"
            alt="avatar"
            (error)="selectedUser.avatarUrl = 'https://i.imgur.com/vtrfxgY.png'">
        </ng-container>
        <ng-template #defaultSelAvatarTpl>
          <img
            src="https://i.imgur.com/vtrfxgY.png"
            class="avatar-sm"
            alt="avatar">
        </ng-template>

        <h2>{{ selectedUser.prenom }} {{ selectedUser.nom }}</h2>
      </div>
      <div class="chat-actions">
        <button mat-icon-button><mat-icon>info</mat-icon></button>
        <button mat-icon-button><mat-icon>more_vert</mat-icon></button>
      </div>
    </header>

    <div class="messages" #scrollContainer>
      <div *ngFor="let m of messages"
           [ngClass]="m.sentBy==='me' ? 'msg-sent' : 'msg-received'">
        <div class="bubble">
          <p>{{ m.text }}</p>
          <span class="time">{{ m.date | date:'HH:mm' }}</span>
        </div>
      </div>
    </div>

    <footer class="chat-input">
      <mat-form-field appearance="outline" class="input-box">
        <input matInput
               [(ngModel)]="newMessage"
               (keyup.enter)="sendMessage()"
               placeholder="Écrire un message…">
      </mat-form-field>
      <button mat-fab color="primary" (click)="sendMessage()">
        <mat-icon>send</mat-icon>
      </button>
    </footer>
  </section>

  <!-- PANEL INFO (optionnel) -->
  <aside class="info-panel" *ngIf="selectedUser && !isMobile">
    <mat-card>
      <mat-card-title>Profil</mat-card-title>
      <mat-card-content>
        <!-- détails supplémentaires ici -->
      </mat-card-content>
    </mat-card>
  </aside>

</div>
