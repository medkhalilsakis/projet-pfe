<!-- src/app/dashboard/dashboard.component.html -->
<div class="dashboard-container" fxLayout="column" fxLayoutAlign="start stretch">

  <!-- Barre supérieure -->
  <mat-toolbar
    color="primary"
    class="top-toolbar"
    fxLayout="row"
    fxLayoutAlign="start center"
    fxFlex="none"
  >
    <!-- Bouton pour plier/déplier la sidebar -->
    <button mat-icon-button (click)="toggleSideNav()" class="toggle-btn">
      <mat-icon>{{ sideNavOpen() ? 'chevron_left' : 'menu' }}</mat-icon>
    </button>

    <span class="app-name">Projexia</span>

    <div class="toolbar-search" fxFlex="30">
      <input class="matInput" matInput placeholder="Rechercher…" fxFlex>
    </div>

    <div class="toolbar-actions" fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="12px">
      <!-- Notifications -->
      <span
        class="action-icon"
        [matBadge]="unreadCount()"
        matBadgeColor="warn"
        matBadgeOverlap="false"
        [matMenuTriggerFor]="notificationsMenu"
        aria-label="Notifications"
      >
        <mat-icon>notifications</mat-icon>
      </span>

      <!-- Profil utilisateur -->
      <ng-container *ngIf="profileImageUrl; else initialsTpl">
        <img
          [src]="profileImageUrl"
          class="profile-img-small action-icon"
          [matMenuTriggerFor]="profileMenu"
          alt="avatar"
        >
      </ng-container>
      <ng-template #initialsTpl>
        <div
          class="profile-circle action-icon"
          [matMenuTriggerFor]="profileMenu"
          aria-label="Menu Profil"
        >
          {{ currentUser?.prenom?.charAt(0) || 'U' }}
          {{ currentUser?.nom?.charAt(0) || 'S' }}
        </div>
      </ng-template>
    </div>
  </mat-toolbar>

  <!-- Contenu principal : menu + zone routée -->
  <div class="main-content" fxLayout="row" fxFlex>
  <app-notification-popup (notiSelected)="viewNotiDetails($event)"></app-notification-popup>

    <!-- Sidebar pliante -->
    <div
  class="side-nav"
  [class.closed]="!sideNavOpen()"
  fxFlex="{{ sideNavOpen() ? '20%' : '0px' }}"
>

  <!-- ===== MENU PRINCIPAL ===== -->
  <mat-nav-list class="main-menu">

    <!-- Itération des items de menu -->
    <ng-container *ngFor="let item of menuItems">

      <!-- ===== ITEM AVEC SOUS-MENU ===== -->
      <ng-container *ngIf="item.subMenu; else singleItem">
        <mat-expansion-panel class="menu-panel" hideToggle>
          <mat-expansion-panel-header class="menu-panel-header">
            <mat-panel-title class="menu-panel-title">
              <mat-icon class="menu-icon">{{ item.icon }}</mat-icon>
              <span class="menu-label">{{ item.label }}</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <mat-nav-list class="submenu-list">
            <a
              mat-list-item
              *ngFor="let sub of item.subMenu"
              (click)="sub.action()"
              [class.active]="currentView() === sub.label"
              class="submenu-item"
            >
              <mat-icon class="submenu-icon" matListItemIcon>chevron_right</mat-icon>
              <span class="submenu-label">{{ sub.label }}</span>
            </a>
          </mat-nav-list>
        </mat-expansion-panel>
      </ng-container>

      <!-- ===== ITEM SIMPLE ===== -->
      <ng-template #singleItem>
        <a
          mat-list-item
          (click)="item.action()"
          [class.active]="currentView() === item.label"
          class="menu-item"
        >
          <mat-icon class="menu-icon" matListItemIcon>{{ item.icon }}</mat-icon>
          <span class="menu-label">{{ item.label }}</span>
        </a>
      </ng-template>
    </ng-container>

    <mat-divider class="menu-divider"></mat-divider>

    <!-- ===== MENU BAS ===== -->
    <mat-nav-list class="bottom-menu">
      <a mat-list-item (click)="navigateTo('settings')" class="bottom-item">
        <mat-icon class="bottom-icon" matListItemIcon>settings</mat-icon>
        <span class="bottom-label">Paramètres</span>
      </a>
      <a mat-list-item (click)="logout()" class="bottom-item">
        <mat-icon class="bottom-icon" matListItemIcon>exit_to_app</mat-icon>
        <span class="bottom-label">Se déconnecter</span>
      </a>
    </mat-nav-list>

  </mat-nav-list>
</div>


    <!-- Zone de contenu routé -->
    <div fxFlex class="content-area">
      <router-outlet></router-outlet>
    </div>
  </div>

  <!-- Menu Notifications -->
  <mat-menu #notificationsMenu="matMenu">
    <ng-container *ngIf="notifications().length; else noNotes">
    <h3 class="notification-header">Notifications ({{unreadCount()}})</h3>
      <button mat-menu-item *ngFor="let n of notifications()" (click)="viewNotificationDetails(n)">
        <mat-icon>{{ n.icon }}</mat-icon>
        <div fxLayout="column">
          <span>{{ n.title }}</span>
          <small>{{ n.createdAt | date:'short' }}</small>
        </div>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="logout()">
        <mat-icon>done_all</mat-icon>
        <span>Tout marquer lu</span>
      </button>
    </ng-container>
    <ng-template #noNotes>
      <button mat-menu-item disabled>
        <mat-icon>notifications_off</mat-icon>
        <span>Aucune notification</span>
      </button>
    </ng-template>
  </mat-menu>

  <!-- Menu Profil -->
  <mat-menu #profileMenu="matMenu">
    <button mat-menu-item (click)="navigateTo('settings')">
      <mat-icon>settings</mat-icon>
      <span>Paramètres</span>
    </button>
    <button mat-menu-item (click)="logout()">
      <mat-icon>exit_to_app</mat-icon>
      <span>Se déconnecter</span>
    </button>
  </mat-menu>

</div>
