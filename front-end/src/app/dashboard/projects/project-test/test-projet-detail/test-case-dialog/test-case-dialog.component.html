<h1 mat-dialog-title>
  {{ data ? 'Éditer' : 'Nouveau' }} cas de test
</h1>

<mat-dialog-content [formGroup]="form" fxLayout="column" fxLayoutGap="16px">
      
  <!-- Ligne 1 & 2 : Numéro & Titre côte à côte sur desktop -->
  <div fxLayout="row wrap" fxLayoutGap="16px">
    <mat-form-field fxFlex.gt-sm="45" fxFlex="100">
      <mat-label>Numéro</mat-label>
      <input matInput formControlName="caseNumber" />
      <mat-error *ngIf="form.get('caseNumber')?.hasError('required')">
        Le numéro est requis
      </mat-error>
      <mat-error *ngIf="form.get('caseNumber')?.hasError('pattern')">
        Doit être un entier positif
      </mat-error>
      <mat-error *ngIf="form.get('caseNumber')?.hasError('caseNumberTaken')">
        Ce numéro existe déjà pour ce projet
      </mat-error>
    </mat-form-field>
    
    
  
    <mat-form-field fxFlex.gt-sm="45" fxFlex="100">
      <mat-label>Date d’exécution</mat-label>
      <input matInput type="date" formControlName="executionDate"/>
      <mat-error *ngIf="form.get('executionDate')?.hasError('required')">
        La date est requise
      </mat-error>
      <mat-error *ngIf="form.get('executionDate')?.hasError('maxToday')">
        La date ne peut pas être dans le futur
      </mat-error>
    </mat-form-field>
    
    
    
    <mat-form-field fxFlex.gt-sm="45" fxFlex="100">
      <mat-label>Titre</mat-label>
      <input matInput formControlName="title"/>
    </mat-form-field>
  </div>

  <!-- Ligne 3 & 4 : Système & Date -->
  <div fxLayout="row wrap" fxLayoutGap="16px">
    <mat-form-field fxFlex.gt-sm="45" fxFlex="100">
      <mat-label>Système / Sous-système</mat-label>
      <input matInput formControlName="subsystem"/>
    </mat-form-field>

  </div>
  <!-- Description & Pré-conditions -->
  <mat-form-field fxFlex="100">
    <mat-label>Description</mat-label>
    <textarea matInput formControlName="description" rows="3"></textarea>
  </mat-form-field>
  <mat-form-field fxFlex="100">
    <mat-label>Pré‑conditions</mat-label>
    <textarea matInput formControlName="preconditions" rows="2"></textarea>
  </mat-form-field>

  <div *ngIf="steps.invalid && (steps.dirty || steps.touched)" class="error">
    Vous devez ajouter au moins une étape.
  </div>
  <!-- Section Étapes -->
  <h3>Étapes</h3>
  <div fxFlex="100" class="steps-table-wrapper">
    <table mat-table [dataSource]="steps.controls" formArrayName="steps" class="mat-elevation-z1">
      <!-- stepDesc -->
      <ng-container matColumnDef="stepDesc">
        <th mat-header-cell *matHeaderCellDef>Étape</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="fill" class="step-field">
            <input matInput placeholder="Étape" formControlName="stepDesc"/>
          </mat-form-field>
        </td>
      </ng-container>
      <!-- action -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef>Action</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="fill" class="step-field">
            <input matInput placeholder="Action" formControlName="action"/>
          </mat-form-field>
        </td>
      </ng-container>
      <!-- expected -->
      <ng-container matColumnDef="expected">
        <th mat-header-cell *matHeaderCellDef>Attendu</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="fill" class="step-field">
            <input matInput placeholder="Attendu" formControlName="expected"/>
          </mat-form-field>
        </td>
      </ng-container>
      <!-- success -->
      <ng-container matColumnDef="success">
        <th mat-header-cell *matHeaderCellDef>Succès</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-checkbox formControlName="success"></mat-checkbox>
        </td>
      </ng-container>
      <!-- comment -->
      <ng-container matColumnDef="comment">
        <th mat-header-cell *matHeaderCellDef>Commentaire</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="fill" class="step-field">
            <input matInput placeholder="Commentaire" formControlName="comment"/>
          </mat-form-field>
        </td>
      </ng-container>
      <!-- remove -->
      <ng-container matColumnDef="remove">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row; let i = index">
          <button mat-icon-button color="warn" (click)="removeStep(i)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row        *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
    <div class="add-step-btn">
      <button mat-mini-fab color="primary" (click)="addStep()"><mat-icon>add</mat-icon></button>
    </div>
  </div>

  <!-- Post‑conditions -->
  <mat-form-field fxFlex="100">
    <mat-label>Post‑conditions</mat-label>
    <textarea matInput formControlName="postconditions" rows="2"></textarea>
  </mat-form-field>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="dialogRef.close()">Annuler</button>
  <button mat-raised-button color="primary" (click)="save()">
    Enregistrer
  </button>
</mat-dialog-actions>
