<div class="container" fxLayout="column" fxLayoutGap="16px">

  <!-- Bannière de pause -->
  <div class="pause-banner" *ngIf="isPaused" fxFlex="none">
    <mat-icon>warning</mat-icon>
    La phase de test a été suspendue par le superviseur. Toutes les fonctionnalités sont désactivées.
  </div>

  <!-- 1. Barre horizontale d’actions (fixe en haut) -->
  <div class="top-bar" fxFlex="none" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
    <button mat-stroked-button color="primary" (click)="openTestCaseDialog()" [disabled]="isPaused">
      <mat-icon>add_circle</mat-icon> Créer un cas
    </button>
    <button mat-stroked-button color="accent" (click)="openBugDialog()" [disabled]="isPaused">
      <mat-icon>bug_report</mat-icon> Signaler un bug
    </button>
    <button mat-stroked-button color="warn" (click)="openMeetingDialog()" [disabled]="isPaused">
      <mat-icon>event</mat-icon> Demander réunion
    </button>
    <button mat-stroked-button color="primary" (click)="openPauseRequest()" [disabled]="isPaused">
      <mat-icon>pause_circle_filled</mat-icon> Demander de suspendre la phase de test
    </button>
    <button mat-stroked-button color="primary" *ngIf="canLaunchTest" (click)="launchTest()" [disabled]="isPaused">
      <mat-icon>play_circle_filled</mat-icon> Lancer le test
    </button>
  </div>

  <!-- 2. Section Projet centrée comme une grande card -->
  <div fxLayout="row" fxLayoutAlign="center center" fxFlex="none">
    <mat-card class="project-details-card" fxFlex="none" style="max-width:800px; width:100%;">
    <!-- Titre du projet -->
    <mat-card-header>
      <mat-card-title>
        <h2>{{ project?.name }}</h2>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Contenu en 3 colonnes -->
      <div fxLayout="row" fxLayoutGap="24px">

        <!-- Colonne 1 -->
        <div fxFlex>
          <p><strong>Utilisateur qui a téléchargé :</strong> {{ project.user.nom }} {{ project.user.prenom }}</p>
          <div *ngIf="project.description">
            <p><strong>Description du projet :</strong></p>
            <p>{{ project.description | slice:0:150 }}...</p>
          </div>
        </div>

        <!-- Colonne 2 -->
        <div fxFlex>
          <p><strong>Date d'upload :</strong> {{ project.createdAt | date:'yyyy-MM-dd HH:mm' }}</p>
          <p><strong>Type du projet :</strong> {{ project.type }}</p>
        </div>

        <!-- Colonne 3 -->
        <div fxFlex>
          <div *ngIf="project.invitedUsers?.length">
            <p><strong>Utilisateurs invités :</strong></p>
            <ul>
              <li *ngFor="let user of project.invitedUsers">
                {{ user.nom }} {{ user.prenom }}
              </li>
            </ul>
          </div>
        </div>

      </div>
    </mat-card-content>

    <!-- Menu d’actions en bas -->
    <mat-card-actions fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
      <button mat-raised-button color="primary" (click)="exploreProject()">Explorer le contenu</button>
      <button mat-raised-button color="accent" (click)="exportProject()">Exporter en ZIP</button>
    </mat-card-actions>
  </mat-card>
</div>


  <!-- 3. Contenu principal : colonnes gauche (30%) et droite (70%) -->
  <div class="main-content" fxLayout="row" fxLayoutGap="16px" fxFlex>

    <!-- Colonne gauche (30%) -->
    <section class="left-col" fxFlex="66%" fxLayout="column" fxLayoutGap="16px">

      <!-- Mes cas de test + Upload -->
      <div class="card tests-block">
        <div class="card-header" fxLayout="row" fxLayoutAlign="space-between center">
          <h2>Mes cas de test</h2>
          <button mat-icon-button color="primary" (click)="uploadTestCases()">
            <mat-icon class="shiny">cloud_upload</mat-icon>
          </button>
        </div>
        <app-test-case-table
          [data]="testCases"
          (edit)="editTestCase($event)"
          (delete)="deleteTestCase($event)"
          (view)="openDetail($event)">
        </app-test-case-table>
      </div>

      <!-- Cas uploadés -->
      <div class="uploads-block">
        <h3>Cas uploadés</h3>
        <mat-list>
          <mat-list-item *ngFor="let up of uploads">
            <div fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="8px">
              <div>
                <div class="filename">{{ up.originalFilename }}</div>
                <div class="date">{{ up.uploadedAt | date:'yyyy-MM-dd HH:mm' }}</div>
              </div>
              <div>
                <button mat-icon-button class="mat-icon-button" (click)="downloadUploaded(up)" matTooltip="Télécharger">
                  <mat-icon>download</mat-icon>
                </button>
                <button mat-icon-button class="mat-icon-button" color="warn" (click)="deleteUploaded(up)" matTooltip="Supprimer">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-list-item>
        </mat-list>
      </div>

      <!-- Réunions planifiées & Bugs -->
      <div fxLayout="row" fxLayoutGap="16px">
        <div class="meetings-block" fxFlex>
          <h3>Réunions planifiées</h3>
          <mat-accordion>
            <mat-expansion-panel *ngFor="let m of meetings">
              <mat-expansion-panel-header>
                <mat-panel-title>{{ m.subject }}</mat-panel-title>
                <mat-panel-description>{{ m.date | date:'yyyy-MM-dd HH:mm' }}</mat-panel-description>
              </mat-expansion-panel-header>
              <p><strong>Participants :</strong> {{ (m.participantNames || []).join(', ') || 'Aucun' }}</p>
              <p>{{ m.description }}</p>

            </mat-expansion-panel>
          </mat-accordion>
        </div>
        <div class="card bugs-block" fxFlex>
          <h3>Bugs signalés</h3>
          <mat-list>
            <mat-list-item *ngFor="let b of bugs">
              <button mat-button (click)="viewBug(b)">Bug #{{ b.id }}</button>
              <span class="bug-level {{ b.level | lowercase }}">
                {{ b.level | titlecase }}
              </span>
            </mat-list-item>
          </mat-list>
        </div>
      </div>

      <!-- Demandes de suspension -->
      <div class="card pause-requests-block">
        <h3>Demandes de suspension</h3>
        <mat-list *ngIf="pauseRequests?.length; else none">
          <mat-list-item *ngFor="let pr of pauseRequests">
            <mat-icon matListIcon>pause_circle</mat-icon>
            <div>
              <div class="requester-name">Demande #{{ pr.id }} </div>
              <div class="small">
                {{ pr.requestedAt | date:'yyyy-MM-dd HH:mm' }} — 
                <em>{{ pr.status | titlecase }}</em>
              </div>
            </div>
            <button mat-button (click)="viewDetails(pr)">Voir les détails</button>
          </mat-list-item>
        </mat-list>
        <ng-template #none><p>Aucune demande de suspension.</p></ng-template>
      </div>

    </section>

    <!-- Colonne droite (70%) -->
    <aside class="right-col" fxFlex="33%" fxLayout="column" fxLayoutGap="16px">

      <!-- Scénario de test -->
      <mat-card class="block scenario-card">
        <mat-card-header>
          <mat-card-title>Scénario de test</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="ViewScenario()">Consulter le scénario de test</button>
        </mat-card-content>
      </mat-card>

      <!-- Types de test -->
      <mat-card class="block">
        <mat-card-header>
          <mat-card-title>Types de test</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="types-grid">
            <mat-checkbox *ngFor="let t of testTypes"
                          [checked]="selectedTypes.has(t)"
                          (change)="selectedTypes.has(t) ? selectedTypes.delete(t) : selectedTypes.add(t)">
              {{ t }}
            </mat-checkbox>
          </div>
          <button mat-raised-button color="primary" (click)="saveTypes()">Valider</button>
        </mat-card-content>
      </mat-card>

      <!-- Niveaux de test -->
      <mat-card class="block levels-card">
        <mat-card-header>
          <mat-card-title>Niveaux de test</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="levels-list">
            <div class="level-node" *ngFor="let lvl of testLevels" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
              <button mat-icon-button (click)="toggleLevel(lvl)">
                <mat-icon>{{ levelStatus[lvl] ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              </button>
              <span (click)="toggleLevel(lvl)">{{ lvl }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </aside>

  </div>

  <!-- 4. Barre finale de décision -->
  <div class="decision-bar" fxFlex="none" fxLayout="row" fxLayoutAlign="space-between center" fxLayoutGap="16px">
    <div fxLayout="row" fxLayoutGap="8px">
      <button mat-flat-button color="primary" (click)="approvePhase()" [disabled]="isPaused">
        <mat-icon>thumb_up</mat-icon> Approuver
      </button>
      <button mat-flat-button color="warn" (click)="rejectPhase()" [disabled]="isPaused">
        <mat-icon>thumb_down</mat-icon> Refuser
      </button>
    </div>
    <div class="file-upload" fxFlex="none">
      Rapport de test final:
      <input  type="file" (change)="onFileChange($event)" [disabled]="isPaused" />
      <span  *ngIf="rapportTestPath">Rapport téléchargé : {{ rapportTestPath }}</span>
    </div>
  </div>

</div>
