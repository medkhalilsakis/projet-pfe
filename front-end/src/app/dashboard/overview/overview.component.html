<div class="dashboard-card" fxLayout="column" fxLayoutGap="24px">

  <!-- Ligne de bienvenue -->
  <div fxLayout="row">
    <div fxFlex="100">
      <div class="welcome-message">
        <h2>
          Bienvenue M. {{ currentUser.nom }} {{ currentUser.prenom }}
        </h2>
      </div>
    </div>
  </div>

  <!-- Conteneur principal en deux colonnes -->
  <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start stretch">
  <!-- Partie gauche (70%) -->
  <div fxFlex="70" fxLayout="column" fxLayoutGap="24px" fxLayoutAlign="start stretch">

    <!-- Ligne 1 : Prochaines réunions + Notes importantes -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start start">
      <!-- Prochaines réunions -->
      <mat-card class="dashboard-card" fxFlex>
        <mat-card-title class="mat-card-title"><mat-icon>event</mat-icon> Prochaines réunions</mat-card-title>
        <mat-card-content class="mat-card-content">
          <mat-progress-spinner *ngIf="meetLoading" mode="indeterminate" diameter="24"></mat-progress-spinner>
          <div class="content-box" *ngIf="!meetLoading && meetings.length">
            <div class="meeting-card" *ngFor="let meeting of meetings" (click)="rootToProject(meeting.project?.id)">
              <h4>{{ meeting.subject }}</h4>
              <p>Date : {{ meeting.date | date:'mediumDate' }} à {{ meeting.time }}</p>
              <p>Description : {{ meeting.description }}</p>
            </div>
          </div>
          <p *ngIf="!meetLoading && !meetings.length" class="empty">Aucune réunion programmée.</p>
        </mat-card-content>
      </mat-card>

      <!-- Notes importantes -->
      <mat-card class="dashboard-card" fxFlex>
  <mat-card-title class="mat-card-title"><mat-icon>note</mat-icon> Notes importantes</mat-card-title>
  <mat-card-content class="mat-card-content">
    <ng-container *ngIf="importantNotes.length > 0; else noNotes">
      <ul>
        <li *ngFor="let note of importantNotes">
          <strong>{{ note.titre }}</strong><br>
          <small>Créée le {{ note.dateCreation | date:'short' }}
          , modifiée le {{ note.dateModification | date:'short' }}</small><br>
          <p>{{ note.contenu }}</p>
        </li>
      </ul>
    </ng-container>
    <ng-template #noNotes>
      <p class="empty">Aucune note importante.</p>
    </ng-template>
  </mat-card-content>
</mat-card>

    </div>

    <!-- Ligne 2 : Mes tâches -->
    <div fxLayout="row" fxLayoutAlign="start start">
      <mat-card *ngIf="!isTester()" class="dashboard-card" fxFlex>
        <mat-card-title class="mat-card-title"><mat-icon>check_circle</mat-icon> Mes tâches</mat-card-title>
        <mat-card-content class="mat-card-content">
          <mat-progress-spinner *ngIf="tasksLoading" mode="indeterminate" diameter="24"></mat-progress-spinner>
          <div class="content-box" *ngIf="!tasksLoading && taches.length">
            <div class="taches-card" *ngFor="let t of taches" (click)="rootToTask(t.id)">
              <mat-icon matListIcon>task</mat-icon>
              <div matLine>Nom : {{ t.name }}, Outils : {{ t.outils }}</div>
            </div>
          </div>
          <p *ngIf="!tasksLoading && !taches.length" class="empty">Aucune tâche en cours.</p>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Ligne 3 : Statistiques + Mes notifications -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start start">
      <!-- Statistiques -->
      <mat-card class="dashboard-card rotating-stats" fxFlex (click)="rootToAnalaytics()">
        <mat-card-title class="mat-card-title">
          <mat-icon>insights</mat-icon> Statistiques
          <div class="stat-indicators">
            <span *ngFor="let _ of statsToRotate; let i=index" [class.active]="currentStatIndex===i">•</span>
          </div>
        </mat-card-title>
        <mat-card-content class="mat-card-content" *ngIf="!statsLoading">
          <div class="current-stat">
            <div class="stat-icon"><mat-icon>{{ currentStat.icon }}</mat-icon></div>
            <div class="stat-content">
              <h3>{{ currentStat.title }}</h3>
              <div class="stat-value">{{ currentStat.value }}</div>
            </div>
          </div>
        </mat-card-content>
        <mat-progress-spinner *ngIf="statsLoading" mode="indeterminate" diameter="40" class="loading-spinner"></mat-progress-spinner>
      </mat-card>

      <!-- Mes notifications -->
      <mat-card class="dashboard-card" fxFlex>
        <mat-card-title class="mat-card-title"><mat-icon>notifications</mat-icon> Mes notifications</mat-card-title>
        <mat-card-content class="mat-card-content"> 
          <mat-progress-spinner *ngIf="notifLoading" mode="indeterminate" diameter="24"></mat-progress-spinner>
          <mat-list *ngIf="!notifLoading && notifications.length">
            <mat-list-item *ngFor="let n of notifications" (click)="rootToNotification(n.id)">
              <mat-icon matListIcon>info</mat-icon>
              <div matLine>{{ n.message }}</div>
              <span matLine class="timestamp">{{ n.date | date:'short' }}</span>
            </mat-list-item>
          </mat-list>
          <p *ngIf="!notifLoading && !notifications.length" class="empty">Pas de nouvelles notifications.</p>
        </mat-card-content>
      </mat-card>
    </div>


    <div fxLayout="row" fxLayoutAlign="start start">
      <mat-card class="dashboard-card invites" fxFlex>
  <mat-card-title>
    <mat-icon>add_circle</mat-icon> Mes invitations
  </mat-card-title>
  <mat-card-content>
    <mat-progress-spinner
      *ngIf="invitedProjects === null"
      mode="indeterminate"
      diameter="24">
    </mat-progress-spinner>

    <ng-container *ngIf="invitedProjects.length > 0; else noInvites">
      <div class="invite-item" *ngFor="let proj of invitedProjects" fxLayout="row" fxLayoutAlign="space-between center">
        <div fxFlex>
          <mat-icon>folder_open</mat-icon>
          {{ proj.name }}
        </div>
        <div fxFlex="none">
          <button mat-button color="primary"
                  (click)="acceptInvite(proj.id)">
            <mat-icon>check</mat-icon> Accepter
          </button>
          <button mat-button color="warn"
                  (click)="rejectInvite(proj.id)">
            <mat-icon>close</mat-icon> Refuser
          </button>
        </div>
      </div>
    </ng-container>

    <ng-template #noInvites>
      <p class="empty">Vous n’avez aucune invitation.</p>
    </ng-template>
  </mat-card-content>
</mat-card>

    </div>
  </div>

  <!-- Partie droite (30%) : Actualités technologiques + Calendrier -->
  <div fxFlex="30" fxLayout="column" fxLayoutGap="24px" fxLayoutAlign="start stretch">

    <!-- Actualités technologiques -->
   <mat-card class="dashboard-card news-widget">
  <mat-card-title class="mat-card-title">
    <mat-icon>public</mat-icon> Actualités technologiques
  </mat-card-title>
  <mat-card-content class="mat-list-item-content">
    <div *ngIf="newsLoading" class="loading">Chargement...</div>
    <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

    <div *ngIf="!newsLoading && !errorMessage">
      <mat-list fxLayout="column" fxLayoutGap="16px">
        <mat-list-item *ngFor="let art of displayedArticles">
          <div class="news-item">
            <img
              *ngIf="art.urlToImage"
              [src]="art.urlToImage"
              alt="thumbnail"
              class="news-thumb"
            />
            <div class="news-content">
              <a [href]="art.url" target="_blank" class="news-title">
                {{ art.title }}
              </a>
              <span class="news-date">{{ art.publishedAt | date:'d MMMM y':'':'fr' }}</span>
            </div>
          </div>
        </mat-list-item>
      </mat-list>
    </div>
  </mat-card-content>
</mat-card>




    <!-- Calendrier -->
    <mat-card class="dashboard-card calendar-placeholder">
      <div class="mbsc-form-group-title">Calendrier</div>
      <mbsc-datepicker [controls]="['calendar']" display="inline" [colors]="coloredDays" [labels]="labelDays"></mbsc-datepicker>
    </mat-card>

  </div>

</div>
